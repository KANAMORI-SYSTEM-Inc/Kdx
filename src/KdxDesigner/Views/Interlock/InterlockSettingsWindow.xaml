<Window x:Class="KdxDesigner.Views.Interlock.InterlockSettingsWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:converters="clr-namespace:KdxDesigner.Utils.Converters"
        xmlns:controls="clr-namespace:KdxDesigner.Controls"
        mc:Ignorable="d"
        Title="インターロック設定" Height="900" Width="1200">

    <Window.Resources>
        <converters:GoOrBackConverter x:Key="GoOrBackConverter"/>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="200"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Background="LightGray" Padding="10">
            <StackPanel>
                <TextBlock FontSize="16" FontWeight="Bold" Text="インターロック設定"/>
                <TextBlock FontSize="14" Margin="0,5,0,0">
                    <TextBlock.Text>
                        <MultiBinding StringFormat="選択中のシリンダー: {0} - {1}">
                            <Binding Path="SelectedCylinder.CYNum"/>
                            <Binding Path="SelectedCylinder.PUCO"/>
                        </MultiBinding>
                    </TextBlock.Text>
                </TextBlock>
                <TextBlock FontSize="14" Margin="0,5,0,0" Text="{Binding SelectedInterlock.CylinderNum, StringFormat='選択中のインターロック: {0}'}"/>
            </StackPanel>
        </Border>

        <!-- Cylinder Selection (共通コンポーネント) -->
        <GroupBox Grid.Row="1" Header="シリンダー選択" Margin="10,5">
            <controls:CylinderListControl
                ItemsSource="{Binding FilteredCylinders}"
                SelectedItem="{Binding SelectedCylinder, Mode=TwoWay}"
                SearchText="{Binding CylinderSearchText, Mode=TwoWay}"
                ClearSearchCommand="{Binding ClearCylinderSearchCommand}"
                DoubleClickCommand="{Binding ShowCylinderPropertiesCommand}"
                ShowToolbar="False"
                ShowSearchBox="True"/>
        </GroupBox>

        <!-- Main Content -->
        <Grid Grid.Row="2" Margin="10">
            <Grid.RowDefinitions>
                <RowDefinition Height="1*"/>
                <RowDefinition Height="1*"/>
                <RowDefinition Height="1*"/>
            </Grid.RowDefinitions>

            <!-- Interlock List -->
            <GroupBox Grid.Row="0" Header="インターロック" Margin="0,0,0,5">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Interlock Toolbar -->
                    <ToolBar Grid.Row="0">
                        <Button Command="{Binding AddInterlockCommand}" Content="追加"/>
                        <Button Command="{Binding DeleteInterlockCommand}" Content="削除"/>
                        <Separator/>
                        <Button Command="{Binding EditPreConditionsCommand}" Content="前提条件編集"/>
                    </ToolBar>

                    <!-- Interlock DataGrid -->
                    <DataGrid Grid.Row="1"
                              ItemsSource="{Binding Interlocks}"
                              SelectedItem="{Binding SelectedInterlock}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              Margin="0,5">
                        <DataGrid.InputBindings>
                            <MouseBinding MouseAction="LeftDoubleClick" Command="{Binding ShowInterlockPropertiesCommand}"/>
                        </DataGrid.InputBindings>
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="ソート" Binding="{Binding SortId}" Width="50"/>
                            <DataGridTextColumn Header="条件CY ID" Binding="{Binding ConditionCylinderId}" Width="70"/>
                            <DataGridTextColumn Header="CY番号" Binding="{Binding ConditionCylinderNum}" Width="80" IsReadOnly="True"/>
                            <DataGridTextColumn Header="前提1" Binding="{Binding PreCondition1Name}" Width="80" IsReadOnly="True"/>
                            <DataGridTextColumn Header="前提2" Binding="{Binding PreCondition2Name}" Width="80" IsReadOnly="True"/>
                            <DataGridTemplateColumn Header="行きor帰り" Width="100">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding GoOrBack, Converter={StaticResource GoOrBackConverter}}"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                <DataGridTemplateColumn.CellEditingTemplate>
                                    <DataTemplate>
                                        <ComboBox ItemsSource="{Binding DataContext.GoOrBackOptions, RelativeSource={RelativeSource AncestorType=Window}}"
                                                  SelectedValue="{Binding GoOrBack, UpdateSourceTrigger=PropertyChanged}"
                                                  SelectedValuePath="Value"
                                                  DisplayMemberPath="DisplayName"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellEditingTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </GroupBox>

            <!-- Interlock Conditions -->
            <GroupBox Grid.Row="1" Header="インターロック条件" Margin="0,5">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Condition Toolbar -->
                    <ToolBar Grid.Row="0">
                        <Button Command="{Binding AddConditionCommand}" Content="追加" IsEnabled="{Binding IsInterlockSelected}"/>
                        <Button Command="{Binding DeleteConditionCommand}" Content="削除"/>
                    </ToolBar>

                    <!-- Conditions DataGrid -->
                    <DataGrid Grid.Row="1"
                              ItemsSource="{Binding InterlockConditions}"
                              SelectedItem="{Binding SelectedCondition}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              Margin="0,5">
                        <DataGrid.InputBindings>
                            <MouseBinding MouseAction="LeftDoubleClick" Command="{Binding ShowConditionPropertiesCommand}"/>
                        </DataGrid.InputBindings>
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="CylinderId" Binding="{Binding CylinderId}" Width="70" IsReadOnly="True"/>
                            <DataGridTextColumn Header="SortId" Binding="{Binding InterlockSortId}" Width="50" IsReadOnly="True"/>
                            <DataGridTextColumn Header="条件番号" Binding="{Binding ConditionNumber}" Width="60" IsReadOnly="True"/>
                            <DataGridTextColumn Header="TypeId" Binding="{Binding ConditionTypeId}" Width="50" IsReadOnly="True"/>
                            <DataGridTemplateColumn Header="条件タイプ" Width="100">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding ConditionType.ConditionTypeName}"
                                                   ToolTip="{Binding ConditionType.Description}"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                <DataGridTemplateColumn.CellEditingTemplate>
                                    <DataTemplate>
                                        <ComboBox ItemsSource="{Binding DataContext.ConditionTypes, RelativeSource={RelativeSource AncestorType=Window}}"
                                                  SelectedValuePath="Id"
                                                  SelectedValue="{Binding ConditionTypeId, UpdateSourceTrigger=PropertyChanged}">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding ConditionTypeName}"
                                                               ToolTip="{Binding Description}"/>
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                        </ComboBox>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellEditingTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTextColumn Header="名前" Binding="{Binding Name, UpdateSourceTrigger=PropertyChanged}" Width="80"/>
                            <DataGridTextColumn Header="デバイス" Binding="{Binding Device, UpdateSourceTrigger=PropertyChanged}" Width="80"/>
                            <DataGridCheckBoxColumn Header="ON条件" Binding="{Binding IsOnCondition, UpdateSourceTrigger=PropertyChanged}" Width="60"/>
                            <DataGridTextColumn Header="コメント1" Binding="{Binding Comment1, UpdateSourceTrigger=PropertyChanged}" Width="120"/>
                            <DataGridTextColumn Header="コメント2" Binding="{Binding Comment2, UpdateSourceTrigger=PropertyChanged}" Width="*"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </GroupBox>

            <!-- Interlock IO -->
            <GroupBox Grid.Row="2" Header="インターロックIO" Margin="0,5,0,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- IO Toolbar -->
                    <ToolBar Grid.Row="0">
                        <Button Command="{Binding AddIOCommand}" Content="IO選択" IsEnabled="{Binding IsConditionSelected}"/>
                        <Button Command="{Binding DeleteIOCommand}" Content="削除"/>
                    </ToolBar>

                    <!-- IO DataGrid -->
                    <DataGrid Grid.Row="1"
                              ItemsSource="{Binding InterlockIOs}"
                              SelectedItem="{Binding SelectedIO}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              Margin="0,5">
                        <DataGrid.InputBindings>
                            <MouseBinding MouseAction="LeftDoubleClick" Command="{Binding ShowIOPropertiesCommand}"/>
                        </DataGrid.InputBindings>
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="CylinderId" Binding="{Binding CylinderId}" Width="70" IsReadOnly="True"/>
                            <DataGridTextColumn Header="SortId" Binding="{Binding InterlockSortId}" Width="50" IsReadOnly="True"/>
                            <DataGridTextColumn Header="条件番号" Binding="{Binding ConditionNumber}" Width="60" IsReadOnly="True"/>
                            <DataGridTextColumn Header="PLC ID" Binding="{Binding PlcId}" Width="50" IsReadOnly="True"/>
                            <DataGridTextColumn Header="IOアドレス" Binding="{Binding IOAddress}" Width="90" IsReadOnly="True"/>
                            <DataGridTextColumn Header="IO名称" Binding="{Binding IOName}" Width="*" IsReadOnly="True"/>
                            <DataGridCheckBoxColumn Header="ON条件" Binding="{Binding IsOnCondition}" Width="60"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </GroupBox>
        </Grid>

        <!-- Bottom Buttons -->
        <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Right" Margin="10">
            <Button Content="再読み込み" Width="100" Height="30" Margin="5" Command="{Binding ReloadCommand}"/>
            <Button Content="保存" Width="100" Height="30" Margin="5" Command="{Binding SaveCommand}"/>
            <Button Content="キャンセル" Width="100" Height="30" Margin="5" Command="{Binding CancelCommand}"/>
        </StackPanel>
    </Grid>
</Window>