<Window x:Class="KdxDesigner.Views.AuditLogView"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d"
        Title="変更履歴" Height="700" Width="1200"
        WindowStartupLocation="CenterOwner">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </Window.Resources>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="200"/>
        </Grid.RowDefinitions>

        <!-- ツールバー -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
            <TextBlock Text="テーブル:" VerticalAlignment="Center" Margin="0,0,5,0"/>
            <ComboBox Width="200"
                      ItemsSource="{Binding TableFilters}"
                      SelectedItem="{Binding SelectedTableFilter}"
                      Margin="0,0,20,0"/>

            <Button Content="更新"
                    Command="{Binding RefreshCommand}"
                    Padding="15,5"
                    Margin="0,0,10,0"/>

            <TextBlock Text="総件数:" VerticalAlignment="Center" Margin="20,0,5,0"/>
            <TextBlock Text="{Binding TotalCount}" VerticalAlignment="Center" FontWeight="Bold"/>
        </StackPanel>

        <!-- データグリッド -->
        <DataGrid Grid.Row="1"
                  ItemsSource="{Binding AuditLogs}"
                  SelectedItem="{Binding SelectedLog}"
                  AutoGenerateColumns="False"
                  IsReadOnly="True"
                  SelectionMode="Single"
                  CanUserAddRows="False"
                  CanUserDeleteRows="False"
                  GridLinesVisibility="Horizontal"
                  AlternatingRowBackground="#F9F9F9">
            <DataGrid.Columns>
                <DataGridTextColumn Header="日時" Binding="{Binding ChangedAt, StringFormat=yyyy/MM/dd HH:mm:ss}" Width="150"/>
                <DataGridTextColumn Header="テーブル" Binding="{Binding TableDisplayName}" Width="120"/>
                <DataGridTextColumn Header="レコードID" Binding="{Binding RecordId}" Width="80"/>
                <DataGridTextColumn Header="操作" Binding="{Binding OperationDisplayName}" Width="60">
                    <DataGridTextColumn.CellStyle>
                        <Style TargetType="DataGridCell">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Operation}" Value="INSERT">
                                    <Setter Property="Background" Value="#E8F5E9"/>
                                    <Setter Property="Foreground" Value="#2E7D32"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Operation}" Value="UPDATE">
                                    <Setter Property="Background" Value="#FFF3E0"/>
                                    <Setter Property="Foreground" Value="#EF6C00"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Operation}" Value="DELETE">
                                    <Setter Property="Background" Value="#FFEBEE"/>
                                    <Setter Property="Foreground" Value="#C62828"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DataGridTextColumn.CellStyle>
                </DataGridTextColumn>
                <DataGridTextColumn Header="変更者" Binding="{Binding ChangedByEmail}" Width="*"/>
            </DataGrid.Columns>
        </DataGrid>

        <!-- ページング -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,10">
            <Button Content="&lt;&lt;" Command="{Binding FirstPageCommand}" Padding="10,5" Margin="2"/>
            <Button Content="&lt;" Command="{Binding PreviousPageCommand}" Padding="10,5" Margin="2"/>
            <TextBlock VerticalAlignment="Center" Margin="10,0">
                <Run Text="{Binding CurrentPage}"/>
                <Run Text=" / "/>
                <Run Text="{Binding TotalPages}"/>
                <Run Text=" ページ"/>
            </TextBlock>
            <Button Content="&gt;" Command="{Binding NextPageCommand}" Padding="10,5" Margin="2"/>
            <Button Content="&gt;&gt;" Command="{Binding LastPageCommand}" Padding="10,5" Margin="2"/>
        </StackPanel>

        <!-- 詳細パネル -->
        <Grid Grid.Row="3" Margin="0,10,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <GroupBox Grid.Column="0" Header="変更前のデータ" Margin="0,0,5,0">
                <ScrollViewer>
                    <TextBox Text="{Binding FormattedOldData, Mode=OneWay}"
                             IsReadOnly="True"
                             FontFamily="Consolas"
                             FontSize="11"
                             TextWrapping="Wrap"
                             AcceptsReturn="True"
                             VerticalScrollBarVisibility="Auto"
                             Background="#FFF5F5F5"/>
                </ScrollViewer>
            </GroupBox>

            <GroupBox Grid.Column="1" Header="変更後のデータ" Margin="5,0,0,0">
                <ScrollViewer>
                    <TextBox Text="{Binding FormattedNewData, Mode=OneWay}"
                             IsReadOnly="True"
                             FontFamily="Consolas"
                             FontSize="11"
                             TextWrapping="Wrap"
                             AcceptsReturn="True"
                             VerticalScrollBarVisibility="Auto"
                             Background="#FFF5FFF5"/>
                </ScrollViewer>
            </GroupBox>
        </Grid>

        <!-- ローディングオーバーレイ -->
        <Border Grid.RowSpan="4"
                Background="#80000000"
                Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <ProgressBar IsIndeterminate="True" Width="200" Height="20"/>
                <TextBlock Text="読み込み中..." Foreground="White" FontSize="14" Margin="0,10,0,0" HorizontalAlignment="Center"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>
